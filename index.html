<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºæ…§å¤©æ°£é¡¯ç¤ºå™¨</title>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        animation: fadeIn 1s ease-in;
    }
    
    .header h1 {
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        margin-bottom: 10px;
    }
    
    .header p {
        font-size: 1.1em;
        opacity: 0.9;
    }
    
    .container {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        width: 100%;
        max-width: 500px;
        backdrop-filter: blur(10px);
        animation: slideUp 0.8s ease-out;
    }
    
    .search-section {
        margin-bottom: 25px;
    }
    
    .search-section h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.2em;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .input-group {
        position: relative;
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    #cityInput {
        flex: 1;
        padding: 15px 50px 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s;
        background: white;
    }
    
    #cityInput:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .voice-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
    }
    
    .voice-btn:hover {
        background: #5568d3;
        transform: translateY(-50%) scale(1.1);
    }
    
    .voice-btn.listening {
        background: #ff6b6b;
        animation: pulse 1s infinite;
    }
    
    .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 50px;
        background: white;
        border: 2px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 12px 12px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .suggestions.show {
        display: block;
    }
    
    .suggestion-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .suggestion-item:hover {
        background: #f5f7fa;
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
    
    .suggestion-highlight {
        font-weight: 600;
        color: #667eea;
    }
    
    button {
        width: 100%;
        padding: 15px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    button:active {
        transform: translateY(0);
    }
    
    .divider {
        height: 2px;
        background: linear-gradient(to right, transparent, #e0e0e0, transparent);
        margin: 25px 0;
    }
    
    .correction-notice {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 10px 15px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #856404;
        display: none;
    }
    
    .correction-notice.show {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }
    
    .weather-result {
        margin-top: 25px;
        text-align: center;
    }
    
    #resultCity {
        color: #667eea;
        font-size: 1.8em;
        font-weight: 600;
        margin-bottom: 15px;
    }
    
    #weather-icon {
        width: 120px;
        height: 120px;
        margin: 15px 0;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        animation: float 3s ease-in-out infinite;
    }
    
    .weather-info {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
        border-radius: 15px;
        margin-top: 20px;
        animation: fadeIn 0.5s ease-in;
    }
    
    .weather-info p {
        margin: 12px 0;
        font-size: 16px;
        line-height: 1.6;
        padding: 10px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .loading {
        text-align: center;
        color: #667eea;
        font-size: 1.2em;
        margin: 20px 0;
    }
    
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
        0%, 100% { transform: translateY(-50%) scale(1); }
        50% { transform: translateY(-50%) scale(1.1); }
    }
    
    @media (max-width: 600px) {
        .header h1 {
            font-size: 2em;
        }
        
        .container {
            padding: 20px;
        }
    }
</style>

</head>
<body>

<div class="header">
    <h1>ğŸŒ¦ï¸ æ™ºæ…§å¤©æ°£é¡¯ç¤ºå™¨</h1>
    <p>æ™ºæ…§æœå°‹ Â· è‡ªå‹•ä¿®æ­£ Â· èªéŸ³è¼¸å…¥</p>
</div>

<div class="container">

    <!-- è‡ªå‹•å®šä½ -->
    <div class="search-section">
        <h3>ğŸ“ è‡ªå‹•å®šä½å¤©æ°£</h3>
        <button onclick="getLocationWeather()">å–å¾—ç›®å‰ä½ç½®å¤©æ°£</button>
    </div>

    <div class="divider"></div>

    <!-- æ‰‹å‹•è¼¸å…¥åŸå¸‚æŸ¥è©¢ -->
    <div class="search-section">
        <h3>ğŸ” æŸ¥è©¢åŸå¸‚å¤©æ°£</h3>
        
        <div id="correctionNotice" class="correction-notice"></div>
        
        <div class="input-group">
            <input id="cityInput" type="text" placeholder="è¼¸å…¥åŸå¸‚åç¨±ï¼ˆæ”¯æ´æ¨¡ç³Šæœå°‹ï¼‰..." autocomplete="off">
            <div class="suggestions" id="suggestions"></div>
            <button class="voice-btn" onclick="startVoiceInput()" id="voiceBtn" title="èªéŸ³è¼¸å…¥">
                ğŸ¤
            </button>
        </div>
        <button onclick="getWeatherByCity()">å–å¾—å¤©æ°£</button>
    </div>

    <!-- å¤©æ°£çµæœ -->
    <div class="weather-result">
        <h3 id="resultCity"></h3>
        <img id="weather-icon" style="display:none;">
        
        <div class="weather-info" id="weatherInfo" style="display:none;">
            <p id="temperature"></p>
            <p id="description"></p>
            <p id="humidity"></p>
            <p id="rain"></p>
            <p id="clothing"></p>
            <p id="umbrella"></p>
        </div>
        
        <div id="loading" style="display:none;">
            <div class="spinner"></div>
            <p class="loading">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

</div>

<script>

const apiKey = "e8ce471283bf66d94a2b914cf56ff549";

// å¤§å¹…æ“´å……çš„åŸå¸‚è³‡æ–™åº«ï¼ˆ200+ åŸå¸‚ï¼‰
const cityMapping = {
    // ===== å°ç£ =====
    "å°åŒ—": "Taipei,TW", "è‡ºåŒ—": "Taipei,TW", "å°åŒ—å¸‚": "Taipei,TW",
    "æ–°åŒ—": "New Taipei City,TW", "æ–°åŒ—å¸‚": "New Taipei City,TW",
    "æ¡ƒåœ’": "Taoyuan,TW", "æ¡ƒåœ’å¸‚": "Taoyuan,TW",
    "å°ä¸­": "Taichung,TW", "è‡ºä¸­": "Taichung,TW", "å°ä¸­å¸‚": "Taichung,TW",
    "å°å—": "Tainan,TW", "è‡ºå—": "Tainan,TW", "å°å—å¸‚": "Tainan,TW",
    "é«˜é›„": "Kaohsiung,TW", "é«˜é›„å¸‚": "Kaohsiung,TW",
    "åŸºéš†": "Keelung,TW", "åŸºéš†å¸‚": "Keelung,TW",
    "æ–°ç«¹": "Hsinchu,TW", "æ–°ç«¹å¸‚": "Hsinchu,TW",
    "å˜‰ç¾©": "Chiayi,TW", "å˜‰ç¾©å¸‚": "Chiayi,TW",
    "è‹—æ —": "Miaoli,TW", "å½°åŒ–": "Changhua,TW",
    "å—æŠ•": "Nantou,TW", "é›²æ—": "Yunlin,TW",
    "å±æ±": "Pingtung,TW", "å®œè˜­": "Yilan,TW",
    "èŠ±è“®": "Hualien,TW", "å°æ±": "Taitung,TW", "è‡ºæ±": "Taitung,TW",
    "æ¾æ¹–": "Penghu,TW", "é‡‘é–€": "Kinmen,TW", "é¦¬ç¥–": "Matsu,TW",
    
    // ===== æ—¥æœ¬ =====
    "æ±äº¬": "Tokyo,JP", "å¤§é˜ª": "Osaka,JP", "äº¬éƒ½": "Kyoto,JP",
    "åå¤å±‹": "Nagoya,JP", "æœ­å¹Œ": "Sapporo,JP", "ç¦å²¡": "Fukuoka,JP",
    "æ©«æ¿±": "Yokohama,JP", "ç¥æˆ¶": "Kobe,JP", "å»£å³¶": "Hiroshima,JP",
    "ä»™å°": "Sendai,JP", "æ²–ç¹©": "Okinawa,JP", "å¥ˆè‰¯": "Nara,JP",
    "éœå²¡": "Shizuoka,JP", "åƒè‘‰": "Chiba,JP", "åŸ¼ç‰": "Saitama,JP",
    "å²¡å±±": "Okayama,JP", "ç†Šæœ¬": "Kumamoto,JP", "é¹¿å…’å³¶": "Kagoshima,JP",
    "é•·å´": "Nagasaki,JP", "é‡‘æ¾¤": "Kanazawa,JP", "æ–°æ½Ÿ": "Niigata,JP",
    
    // ===== éŸ“åœ‹ =====
    "é¦–çˆ¾": "Seoul,KR", "é‡œå±±": "Busan,KR", "ä»å·": "Incheon,KR",
    "å¤§é‚±": "Daegu,KR", "å¤§ç”°": "Daejeon,KR", "å…‰å·": "Gwangju,KR",
    "æ¿Ÿå·": "Jeju,KR", "è”šå±±": "Ulsan,KR", "æ°´åŸ": "Suwon,KR",
    
    // ===== ä¸­åœ‹ =====
    "åŒ—äº¬": "Beijing,CN", "ä¸Šæµ·": "Shanghai,CN", "å»£å·": "Guangzhou,CN",
    "æ·±åœ³": "Shenzhen,CN", "æˆéƒ½": "Chengdu,CN", "é‡æ…¶": "Chongqing,CN",
    "æ­å·": "Hangzhou,CN", "è¥¿å®‰": "Xi'an,CN", "æ­¦æ¼¢": "Wuhan,CN",
    "å—äº¬": "Nanjing,CN", "å¤©æ´¥": "Tianjin,CN", "è˜‡å·": "Suzhou,CN",
    "é’å³¶": "Qingdao,CN", "é•·æ²™": "Changsha,CN", "é„­å·": "Zhengzhou,CN",
    "å¤§é€£": "Dalian,CN", "å»ˆé–€": "Xiamen,CN", "ç¦å·": "Fuzhou,CN",
    "æ˜†æ˜": "Kunming,CN", "ç€‹é™½": "Shenyang,CN", "å“ˆçˆ¾æ¿±": "Harbin,CN",
    
    // ===== æ¸¯æ¾³ =====
    "é¦™æ¸¯": "Hong Kong,HK", "æ¾³é–€": "Macau,MO",
    
    // ===== æ±å—äº =====
    "æ–°åŠ å¡": "Singapore,SG", "æ›¼è°·": "Bangkok,TH",
    "å‰éš†å¡": "Kuala Lumpur,MY", "æª³åŸ": "Penang,MY",
    "æ²³å…§": "Hanoi,VN", "èƒ¡å¿—æ˜å¸‚": "Ho Chi Minh,VN",
    "é¦¬å°¼æ‹‰": "Manila,PH", "å®¿éœ§": "Cebu,PH",
    "é›…åŠ é”": "Jakarta,ID", "å³‡é‡Œå³¶": "Bali,ID", "æ³—æ°´": "Surabaya,ID",
    "é‡‘é‚Š": "Phnom Penh,KH", "ä»°å…‰": "Yangon,MM",
    "è¬è±¡": "Vientiane,LA", "æ±¶èŠ": "Bandar Seri Begawan,BN",
    
    // ===== å—äº =====
    "æ–°å¾·é‡Œ": "New Delhi,IN", "å­Ÿè²·": "Mumbai,IN", "åŠ çˆ¾å„ç­”": "Kolkata,IN",
    "ç­åŠ ç¾…çˆ¾": "Bangalore,IN", "æ¸…å¥ˆ": "Chennai,IN",
    "ä¼Šæ–¯è˜­é¦¬å·´å¾·": "Islamabad,PK", "å¡æ‹‰å¥‡": "Karachi,PK",
    "é”å¡": "Dhaka,BD", "å¯å€«å¡": "Colombo,LK", "åŠ å¾·æ»¿éƒ½": "Kathmandu,NP",
    
    // ===== æ­æ´² =====
    "å€«æ•¦": "London,GB", "æ›¼å¾¹æ–¯ç‰¹": "Manchester,GB", "æ„›ä¸å ¡": "Edinburgh,GB",
    "å·´é»": "Paris,FR", "é¦¬è³½": "Marseille,FR", "é‡Œæ˜‚": "Lyon,FR", "å°¼æ–¯": "Nice,FR",
    "æŸæ—": "Berlin,DE", "æ…•å°¼é»‘": "Munich,DE", "æ³•è˜­å…‹ç¦": "Frankfurt,DE", "æ¼¢å ¡": "Hamburg,DE",
    "ç¾…é¦¬": "Rome,IT", "ç±³è˜­": "Milan,IT", "å¨å°¼æ–¯": "Venice,IT", "ä½›ç¾…å€«æ–¯": "Florence,IT",
    "é¦¬å¾·é‡Œ": "Madrid,ES", "å·´å¡éš†ç´": "Barcelona,ES", "ç“¦å€«è¥¿äº": "Valencia,ES", "å¡ç¶­äº": "Seville,ES",
    "é˜¿å§†æ–¯ç‰¹ä¸¹": "Amsterdam,NL", "é¹¿ç‰¹ä¸¹": "Rotterdam,NL",
    "å¸ƒé­¯å¡çˆ¾": "Brussels,BE", "ç¶­ä¹Ÿç´": "Vienna,AT", "è˜‡é»ä¸–": "Zurich,CH", "æ—¥å…§ç“¦": "Geneva,CH",
    "æ–¯å¾·å“¥çˆ¾æ‘©": "Stockholm,SE", "å“¥æœ¬å“ˆæ ¹": "Copenhagen,DK", "å¥§æ–¯é™¸": "Oslo,NO",
    "èµ«çˆ¾è¾›åŸº": "Helsinki,FI", "é›·å…‹é›…ç¶­å…‹": "Reykjavik,IS",
    "è¯æ²™": "Warsaw,PL", "å¸ƒæ‹‰æ ¼": "Prague,CZ", "å¸ƒé”ä½©æ–¯": "Budapest,HU",
    "é›…å…¸": "Athens,GR", "é‡Œæ–¯æœ¬": "Lisbon,PT", "éƒ½æŸæ—": "Dublin,IE",
    "è«æ–¯ç§‘": "Moscow,RU", "è–å½¼å¾—å ¡": "Saint Petersburg,RU",
    
    // ===== åŒ—ç¾ =====
    "ç´ç´„": "New York,US", "æ´›æ‰ç£¯": "Los Angeles,US", "èˆŠé‡‘å±±": "San Francisco,US",
    "èŠåŠ å“¥": "Chicago,US", "è¥¿é›…åœ–": "Seattle,US", "æ³¢å£«é “": "Boston,US",
    "æ‹‰æ–¯ç¶­åŠ æ–¯": "Las Vegas,US", "é‚é˜¿å¯†": "Miami,US", "å¥§è˜­å¤š": "Orlando,US",
    "è¯ç››é “": "Washington,US", "è²»åŸ": "Philadelphia,US", "è–åœ°ç‰™å“¥": "San Diego,US",
    "ä¸¹ä½›": "Denver,US", "é³³å‡°åŸ": "Phoenix,US", "ä¼‘å£«é “": "Houston,US",
    "é”æ‹‰æ–¯": "Dallas,US", "äºç‰¹è˜­å¤§": "Atlanta,US", "åº•ç‰¹å¾‹": "Detroit,US",
    "å¤šå€«å¤š": "Toronto,CA", "æº«å“¥è¯": "Vancouver,CA", "è’™ç‰¹å©": "Montreal,CA",
    "æ¸¥å¤ªè¯": "Ottawa,CA", "å¡åŠ åˆ©": "Calgary,CA",
    "å¢¨è¥¿å“¥åŸ": "Mexico City,MX", "åæ˜†": "Cancun,MX",
    
    // ===== å—ç¾ =====
    "å¸ƒå®œè«¾æ–¯è‰¾åˆ©æ–¯": "Buenos Aires,AR", "è–ä¿ç¾…": "Sao Paulo,BR",
    "é‡Œç´„ç†±å…§ç›§": "Rio de Janeiro,BR", "åˆ©é¦¬": "Lima,PE",
    "æ³¢å“¥å¤§": "Bogota,CO", "è–åœ°ç‰™å“¥": "Santiago,CL",
    
    // ===== å¤§æ´‹æ´² =====
    "é›ªæ¢¨": "Sydney,AU", "å¢¨çˆ¾æœ¬": "Melbourne,AU", "å¸ƒé‡Œæ–¯æœ¬": "Brisbane,AU",
    "ä¼¯æ–¯": "Perth,AU", "é˜¿å¾—é›·å¾·": "Adelaide,AU", "ååŸ¹æ‹‰": "Canberra,AU",
    "é»ƒé‡‘æµ·å²¸": "Gold Coast,AU", "é”çˆ¾æ–‡": "Darwin,AU",
    "å¥§å…‹è˜­": "Auckland,NZ", "å¨éˆé “": "Wellington,NZ", "åŸºç£åŸ": "Christchurch,NZ",
    
    // ===== ä¸­æ± =====
    "æœæ‹œ": "Dubai,AE", "é˜¿å¸ƒé”æ¯”": "Abu Dhabi,AE",
    "ä¼Šæ–¯å¦å ¡": "Istanbul,TR", "å®‰å¡æ‹‰": "Ankara,TR",
    "ç‰¹æ‹‰ç¶­å¤«": "Tel Aviv,IL", "è€¶è·¯æ’’å†·": "Jerusalem,IL",
    "åˆ©é›…å¾·": "Riyadh,SA", "å¤šå“ˆ": "Doha,QA", "é–‹ç¾…": "Cairo,EG",
    
    // ===== éæ´² =====
    "ç´„ç¿°å°¼æ–¯å ¡": "Johannesburg,ZA", "é–‹æ™®æ•¦": "Cape Town,ZA",
    "å¥ˆæ´›æ¯”": "Nairobi,KE", "æ‹‰å“¥æ–¯": "Lagos,NG",
    "å¡è–©å¸ƒè˜­å¡": "Casablanca,MA"
};

// å»ºç«‹åå‘ç´¢å¼•ä»¥æ”¯æ´æ¨¡ç³Šæœå°‹
const cityList = Object.keys(cityMapping);

// ----------------------
// è¨ˆç®—ç·¨è¼¯è·é›¢ï¼ˆç”¨æ–¼æ¨¡ç³Šæœå°‹ï¼‰
// ----------------------
function levenshteinDistance(str1, str2) {
    const m = str1.length;
    const n = str2.length;
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (str1[i - 1] === str2[j - 1]) {
                dp[i][j] = dp[i - 1][j - 1];
            } else {
                dp[i][j] = Math.min(
                    dp[i - 1][j] + 1,
                    dp[i][j - 1] + 1,
                    dp[i - 1][j - 1] + 1
                );
            }
        }
    }
    
    return dp[m][n];
}

// ----------------------
// æ¨¡ç³Šæœå°‹åŸå¸‚
// ----------------------
function fuzzySearchCity(input) {
    if (!input || input.length < 1) return [];
    
    const results = [];
    const inputLower = input.toLowerCase();
    
    for (const city of cityList) {
        const cityLower = city.toLowerCase();
        
        // å®Œå…¨åŒ¹é…
        if (cityLower === inputLower) {
            results.push({ city, score: 0, type: 'exact' });
            continue;
        }
        
        // å‰ç¶´åŒ¹é…
        if (cityLower.startsWith(inputLower)) {
            results.push({ city, score: 1, type: 'prefix' });
            continue;
        }
        
        // åŒ…å«åŒ¹é…
        if (cityLower.includes(inputLower)) {
            results.push({ city, score: 2, type: 'contains' });
            continue;
        }
        
        // ç·¨è¼¯è·é›¢åŒ¹é…ï¼ˆå®¹éŒ¯1-2å€‹å­—å…ƒï¼‰
        const distance = levenshteinDistance(inputLower, cityLower);
        if (distance <= 2 && input.length >= 2) {
            results.push({ city, score: 3 + distance, type: 'fuzzy' });
        }
    }
    
    // ä¾ç›¸ä¼¼åº¦æ’åº
    results.sort((a, b) => a.score - b.score);
    
    return results.slice(0, 8); // æœ€å¤šé¡¯ç¤º8å€‹å»ºè­°
}

// ----------------------
// é¡¯ç¤ºå»ºè­°æ¸…å–®
// ----------------------
function showSuggestions(input) {
    const suggestionsDiv = document.getElementById('suggestions');
    const results = fuzzySearchCity(input);
    
    if (results.length === 0) {
        suggestionsDiv.classList.remove('show');
        return;
    }
    
    suggestionsDiv.innerHTML = results.map(result => {
        const city = result.city;
        const code = cityMapping[city].split(',')[1];
        return `<div class="suggestion-item" onclick="selectCity('${city}')">
            <span class="suggestion-highlight">${city}</span> <span style="color:#999; font-size:0.9em;">${code}</span>
        </div>`;
    }).join('');
    
    suggestionsDiv.classList.add('show');
}

// ----------------------
// é¸æ“‡å»ºè­°çš„åŸå¸‚
// ----------------------
function selectCity(city) {
    document.getElementById('cityInput').value = city;
    document.getElementById('suggestions').classList.remove('show');
}

// ----------------------
// éš±è—å»ºè­°æ¸…å–®
// ----------------------
function hideSuggestions() {
    setTimeout(() => {
        document.getElementById('suggestions').classList.remove('show');
    }, 200);
}

// ----------------------
// å°‹æ‰¾æœ€ç›¸ä¼¼çš„åŸå¸‚ï¼ˆç”¨æ–¼è‡ªå‹•ä¿®æ­£ï¼‰
// ----------------------
function findClosestCity(input) {
    if (cityMapping[input]) {
        return { city: input, corrected: false };
    }
    
    const results = fuzzySearchCity(input);
    
    if (results.length > 0 && results[0].score <= 2) {
        return { city: results[0].city, corrected: true };
    }
    
    return null;
}

// ----------------------
// èªéŸ³è¼¸å…¥åŠŸèƒ½
// ----------------------
let recognition = null;

function startVoiceInput() {
    const voiceBtn = document.getElementById("voiceBtn");
    
    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥\nå»ºè­°ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨");
        return;
    }
    
    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        voiceBtn.classList.add('listening');
        voiceBtn.innerHTML = 'ğŸ”´';
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById("cityInput").value = transcript;
            voiceBtn.classList.remove('listening');
            voiceBtn.innerHTML = 'ğŸ¤';
            showSuggestions(transcript);
        };
        
        recognition.onerror = function(event) {
            voiceBtn.classList.remove('listening');
            voiceBtn.innerHTML = 'ğŸ¤';
            
            if (event.error === 'no-speech') {
                alert("æœªåµæ¸¬åˆ°èªéŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡");
            } else if (event.error === 'not-allowed') {
                alert("è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™\né»æ“Šç¶²å€åˆ—å·¦å´åœ–ç¤º â†’ éº¥å…‹é¢¨ â†’ å…è¨±");
            } else {
                alert("èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š" + event.error);
            }
        };
        
        recognition.onend = function() {
            voiceBtn.classList.remove('listening');
            voiceBtn.innerHTML = 'ğŸ¤';
        };
        
        recognition.start();
        
    } catch (error) {
        voiceBtn.classList.remove('listening');
        voiceBtn.innerHTML = 'ğŸ¤';
        alert("ç„¡æ³•å•Ÿå‹•èªéŸ³è¼¸å…¥");
    }
}

// ----------------------
// è‡ªå‹•å®šä½å¤©æ°£
// ----------------------
function getLocationWeather() {
    if (!navigator.geolocation) {
        alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½");
        return;
    }

    showLoading();
    
    // å®šä½é¸é …ï¼šé™ä½ç²¾åº¦è¦æ±‚ä»¥æé«˜æˆåŠŸç‡
    const options = {
        enableHighAccuracy: false,  // æ”¹ç‚º false æé«˜ç›¸å®¹æ€§
        timeout: 15000,             // å»¶é•·åˆ° 15 ç§’
        maximumAge: 30000           // å…è¨±ä½¿ç”¨ 30 ç§’å…§çš„å¿«å–ä½ç½®
    };
    
    navigator.geolocation.getCurrentPosition(
        // æˆåŠŸ
        function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&lang=zh_tw&units=metric`;
            fetchWeather(url);
        },
        // å¤±æ•—
        function(error) {
            hideLoading();
            
            let msg = "ç„¡æ³•å–å¾—å®šä½\n";
            
            if (error.code === 1) {
                msg += "æ¬Šé™è¢«æ‹’çµ•\nè«‹å…è¨±å®šä½æ¬Šé™";
            } else if (error.code === 2) {
                msg += "ç„¡æ³•å–å¾—ä½ç½®\nè«‹ç¢ºèªå®šä½æœå‹™å·²é–‹å•Ÿ";
            } else if (error.code === 3) {
                msg += "å®šä½é€¾æ™‚\nè«‹å†è©¦ä¸€æ¬¡";
            }
            
            alert(msg);
        },
        options
    );
}

// ----------------------
// åŸå¸‚æŸ¥è©¢å¤©æ°£
// ----------------------
function getWeatherByCity() {
    let input = document.getElementById("cityInput").value.trim();
    if (input === "") {
        alert("è«‹è¼¸å…¥åŸå¸‚åç¨±ï¼");
        return;
    }

    // å˜—è©¦å°‹æ‰¾æœ€ç›¸ä¼¼çš„åŸå¸‚
    const result = findClosestCity(input);
    
    if (!result) {
        alert(`æ‰¾ä¸åˆ°åŸå¸‚ã€Œ${input}ã€\nè«‹å˜—è©¦å…¶ä»–åŸå¸‚åç¨±`);
        return;
    }
    
    let city = cityMapping[result.city];
    
    // é¡¯ç¤ºä¿®æ­£é€šçŸ¥
    const correctionNotice = document.getElementById('correctionNotice');
    if (result.corrected) {
        correctionNotice.innerHTML = `ğŸ’¡ æ‚¨æ˜¯å¦è¦æŸ¥è©¢ã€Œ<strong>${result.city}</strong>ã€ï¼Ÿå·²ç‚ºæ‚¨è‡ªå‹•ä¿®æ­£`;
        correctionNotice.classList.add('show');
    } else {
        correctionNotice.classList.remove('show');
    }

    showLoading();
    
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&lang=zh_tw&units=metric`;
    fetchWeather(url);
}

// ----------------------
// é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
// ----------------------
function showLoading() {
    document.getElementById("loading").style.display = "block";
    document.getElementById("weatherInfo").style.display = "none";
    document.getElementById("weather-icon").style.display = "none";
    document.getElementById("resultCity").innerText = "";
}

function hideLoading() {
    document.getElementById("loading").style.display = "none";
}

// ----------------------
// å…±ç”¨ï¼šå–å¾—å¤©æ°£è³‡æ–™ä¸¦é¡¯ç¤º
// ----------------------
function fetchWeather(url) {
    fetch(url)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            hideLoading();
            console.log("API å›æ‡‰:", data);

            if (data.cod && data.cod != 200) {
                alert("æŸ¥ç„¡å¤©æ°£è³‡è¨Šï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æ­£ç¢º");
                return;
            }

            document.getElementById("resultCity").innerText = data.name + " çš„å¤©æ°£";

            // åœ–ç¤º
            const iconCode = data.weather[0].icon;
            const iconURL = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
            document.getElementById("weather-icon").src = iconURL;
            document.getElementById("weather-icon").style.display = "block";

            // é¡¯ç¤ºå¤©æ°£è³‡è¨Šå€å¡Š
            document.getElementById("weatherInfo").style.display = "block";

            // æ•¸æ“š
            document.getElementById("temperature").innerText =
                "ğŸŒ¡ æº«åº¦: " + data.main.temp + "Â°C (é«”æ„Ÿ: " + data.main.feels_like + "Â°C)";

            document.getElementById("description").innerText =
                "â˜ ç‹€æ…‹: " + data.weather[0].description;

            // æ¿•åº¦
            document.getElementById("humidity").innerText =
                "ğŸ’§ æ¿•åº¦: " + data.main.humidity + "%";

            // é™é›¨æ©Ÿç‡å’Œé›¨å…·å»ºè­°
            const rain = data.rain ? data.rain["1h"] || data.rain["3h"] || 0 : 0;
            const weatherMain = data.weather[0].main.toLowerCase();
            
            if (rain > 0) {
                document.getElementById("rain").innerText =
                    "ğŸŒ§ é™é›¨é‡: " + rain + "mm";
                document.getElementById("umbrella").innerText =
                    "â˜” å»ºè­°æ”œå¸¶é›¨å…·ï¼";
                document.getElementById("umbrella").style.color = "#ff6b6b";
                document.getElementById("umbrella").style.fontWeight = "bold";
            } else if (weatherMain.includes("rain") || weatherMain.includes("drizzle")) {
                document.getElementById("rain").innerText =
                    "ğŸŒ§ å¯èƒ½æœ‰é™é›¨";
                document.getElementById("umbrella").innerText =
                    "â˜” å»ºè­°æ”œå¸¶é›¨å…·ä»¥é˜²è¬ä¸€";
                document.getElementById("umbrella").style.color = "#ffa500";
                document.getElementById("umbrella").style.fontWeight = "bold";
            } else if (data.clouds && data.clouds.all > 70) {
                document.getElementById("rain").innerText =
                    "â˜ å¤šé›²ï¼Œé™é›¨æ©Ÿç‡ä½";
                document.getElementById("umbrella").innerText =
                    "ğŸŒ‚ å¯è€ƒæ…®å¸¶æŠŠå‚˜";
                document.getElementById("umbrella").style.color = "#888";
            } else {
                document.getElementById("rain").innerText =
                    "â˜€ é™é›¨æ©Ÿç‡ä½";
                document.getElementById("umbrella").innerText =
                    "ğŸ˜Š ç„¡éœ€æ”œå¸¶é›¨å…·";
                document.getElementById("umbrella").style.color = "#4caf50";
            }

            // ç©¿æ­å»ºè­°
            const temp = data.main.temp;
            let clothingAdvice = "";
            
            if (temp >= 30) {
                clothingAdvice = "ğŸ‘• éå¸¸ç‚ç†±ï¼å»ºè­°ç©¿è‘—è¼•è–„é€æ°£è¡£ç‰©ã€çŸ­è¢–çŸ­è¤²ï¼Œæ³¨æ„é˜²æ›¬";
            } else if (temp >= 25) {
                clothingAdvice = "ğŸ‘” ç‚ç†±å¤©æ°£ï¼Œé©åˆçŸ­è¢–ã€è–„å¤–å¥—ï¼Œæ³¨æ„è£œå……æ°´åˆ†";
            } else if (temp >= 20) {
                clothingAdvice = "ğŸ§¥ èˆ’é©æº«åº¦ï¼Œé•·è¢–è¡£ç‰©æˆ–è–„å¤–å¥—å³å¯";
            } else if (temp >= 15) {
                clothingAdvice = "ğŸ§¥ ç¨æ¶¼ï¼Œå»ºè­°ç©¿è‘—é•·è¢–åŠ è–„å¤–å¥—æˆ–é¢¨è¡£";
            } else if (temp >= 10) {
                clothingAdvice = "ğŸ§¥ åå†·ï¼Œå»ºè­°ç©¿è‘—åšå¤–å¥—æˆ–æ¯›è¡£";
            } else if (temp >= 5) {
                clothingAdvice = "ğŸ§£ å¯’å†·ï¼å»ºè­°ç©¿è‘—åšé‡å¤–å¥—ã€æ¯›è¡£ï¼Œå¯åŠ åœå·¾";
            } else {
                clothingAdvice = "ğŸ§£ éå¸¸å¯’å†·ï¼å»ºè­°ç©¿è‘—ç¾½çµ¨å¤–å¥—ã€æ¯›è¡£ï¼Œé…æˆ´åœå·¾æ‰‹å¥—";
            }
            
            document.getElementById("clothing").innerText = clothingAdvice;
        })
        .catch(err => {
            hideLoading();
            console.error("éŒ¯èª¤è©³æƒ…:", err);
            alert("ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™\nå¯èƒ½åŸå› ï¼šç¶²è·¯é€£ç·šå•é¡Œæˆ– API éŒ¯èª¤");
        });
}

// ----------------------
// äº‹ä»¶ç›£è½
// ----------------------
// è¼¸å…¥æ™‚é¡¯ç¤ºå»ºè­°
document.getElementById("cityInput").addEventListener("input", function(e) {
    showSuggestions(e.target.value);
});

// å¤±å»ç„¦é»æ™‚éš±è—å»ºè­°
document.getElementById("cityInput").addEventListener("blur", hideSuggestions);

// æŒ‰ Enter éµæŸ¥è©¢
document.getElementById("cityInput").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        getWeatherByCity();
    }
});

// é»æ“Šå¤–éƒ¨éš±è—å»ºè­°
document.addEventListener("click", function(e) {
    if (!e.target.closest('.input-group')) {
        document.getElementById('suggestions').classList.remove('show');
    }
});

</script>

</body>
</html>